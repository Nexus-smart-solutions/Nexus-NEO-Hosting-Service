name: Neo VPS Infrastructure CI/CD

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

env:
  AWS_REGION: us-east-2  # Ohio region
  TERRAFORM_VERSION: 1.6.0
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================
  # JOB 1: Code Quality & Security Checks
  # ==========================================
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install pylint flake8 black bandit safety
      
      - name: Run Python Linters
        run: |
          # Format check
          black --check scripts/ || true
          
          # Linting
          flake8 scripts/ --max-line-length=120 --ignore=E501,W503 || true
          
          # Security check
          bandit -r scripts/ -ll || true
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Format Check
        run: |
          terraform fmt -check -recursive || true
      
      - name: Terraform Validate
        run: |
          cd backend
          terraform init -backend=false
          terraform validate
          
          cd ../modules/network
          terraform init -backend=false
          terraform validate
          
          cd ../security
          terraform init -backend=false
          terraform validate
          
          cd ../panel-server
          terraform init -backend=false
          terraform validate
      
      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest
      
      - name: Run TFLint
        run: |
          tflint --init
          tflint --recursive
      
      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: reports/checkov.sarif
      
      - name: Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: reports/checkov.sarif

  # ==========================================
  # JOB 2: Terraform Plan
  # ==========================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: code-quality
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        environment: [dev, staging]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Terraform Init
        run: |
          cd backend
          terraform init
      
      - name: Terraform Plan
        id: plan
        run: |
          cd backend
          terraform plan \
            -var="environment=${{ matrix.environment }}" \
            -out=tfplan-${{ matrix.environment }} \
            -no-color
      
      - name: Upload Plan
        uses: actions/upload-artifact@v3
        with:
          name: tfplan-${{ matrix.environment }}
          path: backend/tfplan-${{ matrix.environment }}
          retention-days: 5
      
      - name: Comment PR with Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `#### Terraform Plan ðŸ“‹ \`${{ matrix.environment }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ==========================================
  # JOB 3: Deploy Backend State Infrastructure
  # ==========================================
  deploy-backend:
    name: Deploy Backend (State Management)
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Deploy Backend Infrastructure
        run: |
          cd backend
          terraform init
          terraform apply -auto-approve
      
      - name: Output Backend Info
        run: |
          cd backend
          terraform output -json > backend-outputs.json
          cat backend-outputs.json
      
      - name: Upload Backend Outputs
        uses: actions/upload-artifact@v3
        with:
          name: backend-outputs
          path: backend/backend-outputs.json

  # ==========================================
  # JOB 4: Provision Customer (Manual Trigger)
  # ==========================================
  provision-customer:
    name: Provision Customer Server
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          pip install boto3 jinja2
      
      - name: Get Customer Configuration
        id: config
        run: |
          # Read from environment secrets or inputs
          echo "domain=${{ secrets.CUSTOMER_DOMAIN }}" >> $GITHUB_OUTPUT
          echo "email=${{ secrets.CUSTOMER_EMAIL }}" >> $GITHUB_OUTPUT
          echo "plan=${{ secrets.CUSTOMER_PLAN }}" >> $GITHUB_OUTPUT
      
      - name: Run Provisioning Script
        run: |
          chmod +x automation/provision-customer.sh
          
          ./automation/provision-customer.sh \
            --domain ${{ steps.config.outputs.domain }} \
            --email ${{ steps.config.outputs.email }} \
            --plan ${{ steps.config.outputs.plan }} \
            --region ${{ env.AWS_REGION }}
      
      - name: Wait for Provisioning
        run: |
          echo "Waiting for provisioning to complete..."
          sleep 60
      
      - name: Verify Deployment
        run: |
          # Check if instance is running
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Domain,Values=${{ steps.config.outputs.domain }}" \
            --query 'Reservations[0].Instances[0].InstanceId' \
            --output text)
          
          echo "Instance ID: $INSTANCE_ID"
          
          aws ec2 wait instance-status-ok --instance-ids $INSTANCE_ID
          
          echo "âœ… Instance is running and healthy"
      
      - name: Send Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âœ… Server Provisioned: ${{ steps.config.outputs.domain }}"
          to: ${{ steps.config.outputs.email }}
          from: Neo VPS Platform <noreply@neo-vps.com>
          body: |
            Your server has been provisioned successfully!
            
            Domain: ${{ steps.config.outputs.domain }}
            Plan: ${{ steps.config.outputs.plan }}
            Region: ${{ env.AWS_REGION }}
            
            Access details will be sent separately.

  # ==========================================
  # JOB 5: DNS Automation
  # ==========================================
  dns-automation:
    name: DNS Configuration
    runs-on: ubuntu-latest
    needs: provision-customer
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Dependencies
        run: |
          pip install boto3
      
      - name: Get Server IPs
        id: ips
        run: |
          DOMAIN="${{ secrets.CUSTOMER_DOMAIN }}"
          
          # Get server IP
          SERVER_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Domain,Values=$DOMAIN" "Name=tag:Type,Values=Panel" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          # Get DNS server IPs
          NS1_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Domain,Values=$DOMAIN" "Name=tag:Type,Values=DNS" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "ns1_ip=$NS1_IP" >> $GITHUB_OUTPUT
      
      - name: Run DNS Automation
        run: |
          chmod +x scripts/dns-automation.py
          
          python3 scripts/dns-automation.py \
            "${{ secrets.CUSTOMER_DOMAIN }}" \
            "${{ steps.ips.outputs.server_ip }}" \
            "${{ steps.ips.outputs.ns1_ip }}"
      
      - name: Verify DNS
        run: |
          echo "Waiting for DNS propagation..."
          sleep 30
          
          dig @8.8.8.8 ${{ secrets.CUSTOMER_DOMAIN }} +short || true

  # ==========================================
  # JOB 6: Security Scan
  # ==========================================
  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: TFSec Security Scanner
        uses: aquasecurity/tfsec-action@v1.0.0
        with:
          soft_fail: true

  # ==========================================
  # JOB 7: Destroy Infrastructure (Manual)
  # ==========================================
  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
      
      - name: Confirm Destruction
        run: |
          echo "âš ï¸  WARNING: About to destroy infrastructure!"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
      
      - name: Terraform Destroy
        run: |
          cd backend
          terraform init
          terraform destroy -auto-approve \
            -var="environment=${{ github.event.inputs.environment }}"
      
      - name: Send Destruction Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "âš ï¸ Infrastructure Destroyed: ${{ github.event.inputs.environment }}"
          to: ${{ secrets.ADMIN_EMAIL }}
          from: Neo VPS Platform <noreply@neo-vps.com>
          body: |
            Infrastructure has been destroyed.
            
            Environment: ${{ github.event.inputs.environment }}
            Triggered by: ${{ github.actor }}
            Time: ${{ github.event.repository.updated_at }}

  # ==========================================
  # JOB 8: Cost Estimation
  # ==========================================
  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
      
      - name: Generate Cost Estimate
        run: |
          infracost breakdown \
            --path backend \
            --format json \
            --out-file infracost.json
      
      - name: Post Cost Comment
        run: |
          infracost comment github \
            --path infracost.json \
            --repo $GITHUB_REPOSITORY \
            --pull-request ${{ github.event.pull_request.number }} \
            --github-token ${{ secrets.GITHUB_TOKEN }} \
            --behavior update

  # ==========================================
  # JOB 9: Backup State Files
  # ==========================================
  backup-state:
    name: Backup Terraform State
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Backup State to S3
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          
          # Copy state file to backup location
          aws s3 cp \
            s3://neo-terraform-state/terraform.tfstate \
            s3://neo-terraform-state-backups/$TIMESTAMP/terraform.tfstate
          
          echo "âœ… State backed up to s3://neo-terraform-state-backups/$TIMESTAMP/"

# ==========================================
# Workflow Complete
# ==========================================
