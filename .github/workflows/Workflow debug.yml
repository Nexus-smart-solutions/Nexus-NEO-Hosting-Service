name: "NEO Infrastructure Automation - DEBUG"

on:
  workflow_dispatch:
    inputs:
      domain: 
        required: true
        description: 'Domain'
        default: 'test.example.com'
      email: 
        required: true
        description: 'Email'
        default: 'test@example.com'
      tier: 
        required: true
        description: 'Tier'
        default: 'basic'
      client_id: 
        required: true
        description: 'Client ID'
        default: 'test-123'

jobs:
  debug-structure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: ðŸ” Debug - Full Repository Structure
        run: |
          echo "======================================"
          echo "ðŸ” REPOSITORY STRUCTURE DIAGNOSTIC"
          echo "======================================"
          echo ""
          
          echo "ðŸ“ Current directory:"
          pwd
          echo ""
          
          echo "ðŸ“‚ Root directory contents:"
          ls -la
          echo ""
          
          echo "ðŸ” Looking for 'modules' directory:"
          find . -type d -name "modules" -maxdepth 3
          echo ""
          
          echo "ðŸ“ Modules directory contents (if exists):"
          ls -la modules/ 2>/dev/null || echo "âŒ modules/ not found in root"
          echo ""
          
          echo "ðŸ” Looking for 'template' directory:"
          find . -type d -name "template" -maxdepth 5
          echo ""
          
          echo "ðŸ“‚ Full tree (3 levels):"
          tree -L 3 -a 2>/dev/null || find . -maxdepth 3 -type d | head -30
          echo ""
          
          echo "ðŸ“‹ Template directory structure:"
          if [ -d "environments/customers/template" ]; then
            cd environments/customers/template
            echo "âœ… Template directory found"
            pwd
            ls -la
            echo ""
            
            echo "ðŸ” Checking main.tf module sources:"
            grep -n "source.*=" main.tf 2>/dev/null || echo "main.tf not found"
            echo ""
            
            echo "ðŸ“ Testing relative paths from template:"
            echo "   ../../../ exists? $([ -d ../../../ ] && echo 'YES âœ…' || echo 'NO âŒ')"
            echo "   ../../../ points to: $(cd ../../../ && pwd)"
            echo "   ../../../modules exists? $([ -d ../../../modules ] && echo 'YES âœ…' || echo 'NO âŒ')"
            
            if [ -d ../../../modules ]; then
              echo "   ../../../modules contents:"
              ls -la ../../../modules/
            fi
          else
            echo "âŒ Template directory not found"
          fi
          
      - name: ðŸ§ª Test Module Path Solutions
        run: |
          echo ""
          echo "======================================"
          echo "ðŸ§ª TESTING SOLUTIONS"
          echo "======================================"
          echo ""
          
          cd environments/customers/template
          REPO_ROOT=$(git rev-parse --show-toplevel)
          
          echo "ðŸ“ Repository root: $REPO_ROOT"
          echo ""
          
          echo "Test 1: Direct path from repo root"
          echo "   $REPO_ROOT/modules exists? $([ -d $REPO_ROOT/modules ] && echo 'YES âœ…' || echo 'NO âŒ')"
          
          echo ""
          echo "Test 2: Relative path ../../../modules"
          echo "   Resolved path: $(realpath ../../../modules 2>/dev/null || echo 'CANNOT RESOLVE')"
          
          echo ""
          echo "Test 3: Symlink approach"
          ln -s "$REPO_ROOT/modules" ./test-symlink 2>/dev/null && echo "   Symlink works âœ…" || echo "   Symlink failed âŒ"
          ls -la test-symlink 2>/dev/null || true
          rm -f test-symlink
          
          echo ""
          echo "Test 4: What does ../../../ actually point to?"
          (cd ../../../ && pwd && ls -la)
