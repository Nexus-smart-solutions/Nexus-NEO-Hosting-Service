name: Terraform CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  TF_VERSION: 1.6.6
  AWS_REGION: us-east-2

jobs:
  terraform:
    name: 'Terraform Validate'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # ================================================================
      # AUTO-FIX: Format issues automatically
      # ================================================================
      - name: Terraform Format (Auto-fix)
        run: |
          echo "Formatting Terraform files..."
          terraform fmt -recursive
          
          # Check if any files were changed
          if [[ -n $(git status --porcelain) ]]; then
            echo "⚠️ Formatting changes detected!"
            git diff
            echo ""
            echo "Run 'terraform fmt -recursive' locally and commit the changes."
            exit 1
          else
            echo "✓ All files properly formatted"
          fi
      
      # ================================================================
      # Terraform Init (WITHOUT backend for CI)
      # ================================================================
      - name: Terraform Init
        run: terraform init -backend=false
      
      # ================================================================
      # Terraform Validate
      # ================================================================
      - name: Terraform Validate
        run: terraform validate
      
      # ================================================================
      # Success Message
      # ================================================================
      - name: Success
        run: |
          echo "✅ All checks passed!"
          echo "- Formatting: OK"
          echo "- Validation: OK"
