name: "NEO Infrastructure - Force Refresh"

on:
  workflow_dispatch:
    inputs:
      domain: 
        required: true
        description: 'Domain'
        default: 'test.example.com'
      email: 
        required: true
        description: 'Email'
        default: 'test@example.com'
      tier: 
        required: true
        description: 'Tier'
        default: 'basic'
      client_id: 
        required: true
        description: 'Client ID'
        default: 'test-123'

jobs:
  provision:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the repository
      - name: Checkout Repository (Force Clean)
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0
      
      # 2. Set up Terraform Environment
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false

      # 3. Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      # 4. Provision Infrastructure
      - name: Provision Infrastructure
        id: terraform_step
        env:
          CUSTOMER_DOMAIN: ${{ github.event.inputs.domain }}
          CUSTOMER_EMAIL: ${{ github.event.inputs.email }}
          PLAN_TIER: ${{ github.event.inputs.tier }}
          CLIENT_ID: ${{ github.event.inputs.client_id }}
        run: |
          cd environments/customers/template/
          
          echo "üì¶ Initializing Terraform..."
          terraform init -reconfigure \
            -backend-config="bucket=hosting-company-terraform-state-093063750620" \
            -backend-config="region=us-east-2" \
            -backend-config="key=customers/${CUSTOMER_DOMAIN}/terraform.tfstate"
          
          echo "‚ú® Applying Changes..."
          terraform apply -auto-approve \
            -var="customer_domain=${CUSTOMER_DOMAIN}" \
            -var="customer_email=${CUSTOMER_EMAIL}" \
            -var="plan_tier=${PLAN_TIER}" \
            -var="client_id=${CLIENT_ID}" \
            -var="instance_type=t3.medium" \
            -var="data_volume_size=100" \
            -var="region=us-east-2"

      # 5. Extract Outputs and Notify System (Safe Version)
      - name: Extract Outputs and Notify System
        if: success()
        env:
          API_URL: ${{ secrets.SYSTEM_API_URL }} # ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ∂ÿßŸÅÿ© Ÿáÿ∞ÿß ŸÅŸä GitHub Secrets
        run: |
          cd environments/customers/template/
          
          # Extracting outputs correctly from our updated outputs.tf
          IP=$(terraform output -raw server_public_ip)
          URL=$(terraform output -raw website_url)
          NS=$(terraform output -json domain_name_servers)
          
          echo "üöÄ Deployment successful for Domain: ${{ github.event.inputs.domain }}"

          # Check if API_URL exists to avoid "Malformed input" error
          if [ -z "$API_URL" ] || [ "$API_URL" == "ÿ∫Ÿäÿ±ŸÜŸä ŸÑŸÑ API Ÿäÿ≥ÿ∑ÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿßÿß" ]; then
            echo "‚ö†Ô∏è API_URL is not set or is a placeholder. Skipping notification."
            echo "Server IP: $IP."
            echo "Website: $URL."
          else
            echo "Sending callback to system..."
            curl -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.SYSTEM_API_TOKEN }}" \
              -d "{
                \"client_id\": \"${{ github.event.inputs.client_id }}\",
                \"ip_address\": \"$IP\",
                \"domain\": \"${{ github.event.inputs.domain }}\",
                \"website_url\": \"$URL\",
                \"name_servers\": $NS,
                \"status\": \"active\"
              }"
          fi
