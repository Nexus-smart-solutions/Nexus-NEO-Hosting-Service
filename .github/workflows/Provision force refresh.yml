name: "NEO Infrastructure - Force Refresh"

on:
  workflow_dispatch:
    inputs:
      domain: 
        required: true
        description: 'Domain'
        default: 'test.example.com'
      email: 
        required: true
        description: 'Email'
        default: 'test@example.com'
      tier: 
        required: true
        description: 'Tier'
        default: 'basic'
      client_id: 
        required: true
        description: 'Client ID'
        default: 'test-123'

jobs:
  provision:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository (Force Clean)
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0
      
      - name: Verify Files
        run: |
          echo "üîç Checking main.tf content:"
          echo "================================"
          cat environments/customers/template/main.tf | head -20
          echo "================================"
          echo ""
          echo "üîç Checking backend.tf content:"
          echo "================================"
          cat environments/customers/template/backend.tf
          echo "================================"
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      - name: Provision Infrastructure
        env:
          CUSTOMER_DOMAIN: ${{ github.event.inputs.domain }}
          CUSTOMER_EMAIL: ${{ github.event.inputs.email }}
          PLAN_TIER: ${{ github.event.inputs.tier }}
          CLIENT_ID: ${{ github.event.inputs.client_id }}
        run: |
          cd environments/customers/template/
          
          echo "üöÄ Starting Terraform provisioning for ${CUSTOMER_DOMAIN}"
          echo "=================================================="
          
          echo "üì¶ Initializing Terraform..."
          terraform init -reconfigure \
            -backend-config="bucket=hosting-company-terraform-state-093063750620" \
            -backend-config="region=us-east-2" \
            -backend-config="key=customers/${CUSTOMER_DOMAIN}/terraform.tfstate"
          
          echo ""
          echo "üìã Planning infrastructure changes..."
          terraform plan \
            -var="customer_domain=${CUSTOMER_DOMAIN}" \
            -var="customer_email=${CUSTOMER_EMAIL}" \
            -var="plan_tier=${PLAN_TIER}" \
            -var="client_id=${CLIENT_ID}" \
            -var="instance_type=t3.medium" \
            -var="data_volume_size=100" \
            -var="region=us-east-2"
          
          echo ""
          echo "‚ú® Applying infrastructure changes..."
          terraform apply -auto-approve \
            -var="customer_domain=${CUSTOMER_DOMAIN}" \
            -var="customer_email=${CUSTOMER_EMAIL}" \
            -var="plan_tier=${PLAN_TIER}" \
            -var="client_id=${CLIENT_ID}" \
            -var="instance_type=t3.medium" \
            -var="data_volume_size=100" \
            -var="region=us-east-2"
          
          echo ""
          echo "üéâ Provisioning completed successfully!"
      
      - name: Capture Outputs
        if: success()
        run: |
          cd environments/customers/template/
          echo "üì§ Infrastructure Outputs:"
          terraform output -json
