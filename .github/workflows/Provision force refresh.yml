name: "NEO Infrastructure - Force Refresh"

on:
  workflow_dispatch:
    inputs:
      domain: 
        required: true
        description: 'Domain'
        default: 'test.example.com'
      email: 
        required: true
        description: 'Email'
        default: 'test@example.com'
      tier: 
        required: true
        description: 'Tier'
        default: 'basic'
      client_id: 
        required: true
        description: 'Client ID'
        default: 'test-123'

jobs:
  provision:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Ø³Ø­Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      - name: Checkout Repository (Force Clean)
        uses: actions/checkout@v3
        with:
          clean: true
          fetch-depth: 0
      
      # 2. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø´ØºÙ„ (Ù„Ù„Ø£Ù…Ø§Ù†)
      - name: Verify Files
        run: |
          echo "ğŸ” Checking main.tf and backend.tf"
          cat environments/customers/template/main.tf | head -20
          cat environments/customers/template/backend.tf
      
      # 3. Ø¥Ø¹Ø¯Ø§Ø¯ ØªÙŠØ±Ø§Ø±ÙÙˆØ±Ù… ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø£ÙƒØ´Ù†
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false # Ù„Ø§Ø²Ù… false Ø¹Ø´Ø§Ù† Ù†Ø¹Ø±Ù Ù†Ø³Ø­Ø¨ Ø§Ù„Ù€ outputs ÙƒÙ…ØªØºÙŠØ±Ø§Øª

      # 4. ØªØ¹Ø±ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2
      
      # 5. ØªØ´ØºÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù€ Provisioning (Init, Plan, Apply)
      - name: Provision Infrastructure
        id: terraform_step
        env:
          CUSTOMER_DOMAIN: ${{ github.event.inputs.domain }}
          CUSTOMER_EMAIL: ${{ github.event.inputs.email }}
          PLAN_TIER: ${{ github.event.inputs.tier }}
          CLIENT_ID: ${{ github.event.inputs.client_id }}
        run: |
          cd environments/customers/template/
          
          echo "ğŸ“¦ Initializing Terraform..."
          terraform init -reconfigure \
            -backend-config="bucket=hosting-company-terraform-state-093063750620" \
            -backend-config="region=us-east-2" \
            -backend-config="key=customers/${CUSTOMER_DOMAIN}/terraform.tfstate"
          
          echo "âœ¨ Applying Changes..."
          terraform apply -auto-approve \
            -var="customer_domain=${CUSTOMER_DOMAIN}" \
            -var="customer_email=${CUSTOMER_EMAIL}" \
            -var="plan_tier=${PLAN_TIER}" \
            -var="client_id=${CLIENT_ID}" \
            -var="instance_type=t3.medium" \
            -var="data_volume_size=100" \
            -var="region=us-east-2"

      # 6. Ø³Ø­Ø¨ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª (Outputs) ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ Callback Ù„Ù„Ø³ÙŠØ³ØªÙ…
      - name: Extract Outputs and Notify System
        if: success()
        run: |
          cd environments/customers/template/
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ØªÙŠØ±Ø§Ø±ÙÙˆØ±Ù…
          IP=$(terraform output -raw elastic_ip)
          CLIENT=$(terraform output -raw client_id)
          WHM=$(terraform output -raw whm_url)
          
          echo "ğŸš€ Deployment successful. Notifying system for Client: $CLIENT"

          # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø¨ØªØ§Ø¹ÙƒÙ…
          # Ù…Ù„Ø§Ø­Ø¸Ø©: ØºÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ø¯Ù‡ Ù„Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø§Ù„Ù„ÙŠ Ø§Ù„Ù…Ø·ÙˆØ±ÙŠÙ† Ù…Ø¯ÙŠÙ†Ù‡ÙˆÙ„Ùƒ
          curl -X POST "ØºÙŠØ±Ù†ÙŠ Ù„Ù„ API ÙŠØ³Ø·Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§Ø§" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SYSTEM_API_TOKEN }}" \
            -d "{
              \"client_id\": \"$CLIENT\",
              \"ip_address\": \"$IP\",
              \"whm_url\": \"$WHM\",
              \"domain\": \"${{ github.event.inputs.domain }}\",
              \"status\": \"active\"
            }"
